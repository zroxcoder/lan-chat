<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LAN Messenger</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --vh: 1vh;
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --sidebar: rgba(255, 255, 255, 0.1);
    --chat-bg: rgba(255, 255, 255, 0.05);
    --primary: #667eea;
    --accent: #48bb78;
    --text: #ffffff;
    --text-muted: rgba(255,255,255,0.7);
    --msg-in: rgba(255, 255, 255, 0.1);
    --msg-out: linear-gradient(135deg, #667eea, #764ba2);
    --input-bg: rgba(255, 255, 255, 0.1);
    --separator: rgba(255,255,255,0.2);
    --danger: #ff6b6b;
    --success: #48bb78;
    --glass: rgba(255, 255, 255, 0.1);
    --glass-border: rgba(255, 255, 255, 0.2);
}

* {
    box-sizing: border-box; 
    margin: 0;
    padding: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: fixed;
}

body {
    background: var(--bg);
    color: var(--text);
    height: calc(var(--vh, 1vh) * 100);
    display: flex;
    flex-direction: column;
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }

#login {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.login-box {
    background: var(--glass);
    backdrop-filter: blur(20px);
    padding: 40px 30px;
    border-radius: 20px;
    text-align: center;
    width: 90%;
    max-width: 350px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    border: 1px solid var(--glass-border);
    animation: fadeInUp 0.6s ease-out;
}

.login-box h2 {
    margin-bottom: 10px;
    color: white;
    font-size: 28px;
    font-weight: 700;
}

.login-box p {
    color: rgba(255,255,255,0.8);
    margin-bottom: 25px;
    font-size: 13px;
}

.login-box input {
    width: 100%;
    padding: 12px 16px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: white;
    outline: none;
    font-size: 15px;
    transition: all 0.3s;
}

.login-box input::placeholder {
    color: rgba(255,255,255,0.6);
}

.login-box input:focus {
    border-color: white;
    background: rgba(255,255,255,0.15);
}

.login-box button {
    width: 100%;
    padding: 12px;
    background: white;
    color: #667eea;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    font-size: 15px;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.login-box button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

#status {
    margin-top: 15px;
    font-size: 12px;
    color: rgba(255,255,255,0.9);
}

#app {
    display: none;
    height: calc(var(--vh, 1vh) * 100);
    width: 100%;
    position: relative;
    overflow: hidden;
}

.sidebar {
    width: 280px;
    background: var(--sidebar);
    backdrop-filter: blur(20px);
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--separator);
    overflow-y: auto;
    flex-shrink: 0;
    border-radius: 0 20px 20px 0;
    box-shadow: 0 0 40px rgba(0,0,0,0.2);
    position: relative;
    height: 100%;
}

.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--chat-bg);
    min-width: 0;
    height: 100%;
    position: relative;
}

.header {
    padding: 15px 18px;
    background: var(--glass);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--separator);
    height: 60px;
    flex-shrink: 0;
    border-radius: 0 0 20px 20px;
}

.section-label {
    padding: 12px 16px 8px;
    color: var(--text-muted);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.user-item, .channel-item {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s;
    margin: 0 8px;
    border-radius: 8px;
    user-select: none;
}

.user-item:hover, .channel-item:hover {
    background: rgba(102, 126, 234, 0.1);
}

.user-item.active, .channel-item.active {
    background: var(--primary);
    color: white;
}

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary);
    flex-shrink: 0;
}

#messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: var(--chat-bg);
    backdrop-filter: blur(5px);
    -webkit-overflow-scrolling: touch;
}

.msg {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.4;
    overflow-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    word-break: break-word;
    animation: slideIn 0.3s ease-out;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}

.msg.self {
    align-self: flex-end;
    background: var(--msg-out);
    color: white;
    border-bottom-right-radius: 4px;
}

.msg.other {
    align-self: flex-start;
    background: var(--msg-in);
    border-bottom-left-radius: 4px;
}

.msg.system {
    align-self: center;
    background: rgba(255,255,255,0.05);
    color: var(--text-muted);
    font-size: 12px;
    border-radius: 16px;
    padding: 6px 12px;
    margin: 10px 0;
    max-width: 90%;
}

.media-container {
    max-width: 280px;
    max-height: 280px;
    margin-top: 6px;
    border-radius: 10px;
    overflow: hidden;
    background: black;
    display: inline-block;
}

.media-container img, .media-container video {
    max-width: 100%;
    max-height: 100%;
    display: block;
    object-fit: cover;
    cursor: pointer;
}

.msg audio {
    max-width: 100%;
    border-radius: 6px;
    margin-top: 6px;
    display: block;
    height: 32px;
}

.sender-name {
    font-size: 11px;
    color: var(--accent);
    margin-bottom: 3px;
    display: block;
    font-weight: 600;
}

.input-area {
    background: var(--glass);
    backdrop-filter: blur(10px);
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    border-top: 1px solid var(--separator);
    border-radius: 20px 20px 0 0;
}

.input-area input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 20px;
    border: none;
    background: var(--input-bg);
    color: var(--text);
    outline: none;
    font-size: 14px;
    min-width: 0;
}

.input-area input:focus {
    background: rgba(102, 126, 234, 0.15);
}

.icon-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 18px;
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    transition: all 0.2s;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
}

.icon-btn:hover {
    color: var(--primary);
    background: rgba(102, 126, 234, 0.1);
}

.icon-btn:active {
    transform: scale(0.9);
}

.recording {
    color: var(--danger);
    animation: pulse 1.5s infinite;
}

#menu-btn {
    display: none;
}

#close-btn {
    display: none;
}

#sticker-picker {
    display: none;
    position: fixed;
    bottom: 70px;
    right: 10px;
    background: var(--glass);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 10px;
    max-width: 300px;
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

/* Mobile Styles */
@media(max-width: 768px) {
    #app {
        display: flex;
        flex-direction: row;
    }
    
    .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        height: 100%;
        width: 75%;
        max-width: 280px;
        z-index: 1002;
        transition: left 0.3s ease;
        border-radius: 0 20px 20px 0;
    }
    
    .sidebar.show {
        left: 0;
    }
    
    .chat-area {
        width: 100%;
        flex: 1;
    }
    
    #menu-btn {
        display: flex;
    }
    
    #close-btn {
        display: flex;
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
    }
    
    .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1001;
    }
    
    .sidebar-overlay.show {
        display: block;
    }
    
    .msg {
        max-width: 85%;
        font-size: 13px;
    }
    
    .media-container {
        max-width: 200px;
        max-height: 200px;
    }
    
    #sticker-picker {
        bottom: 65px;
        right: 5px;
        left: 5px;
        max-width: calc(100% - 10px);
        max-height: 250px;
        padding: 8px;
    }
}

@media(max-width: 480px) {
    .sidebar {
        width: 80%;
        max-width: 240px;
    }
    
    .login-box {
        width: 95%;
        padding: 30px 20px;
    }
    
    .login-box h2 {
        font-size: 24px;
    }
    
    .input-area {
        padding: 8px;
        gap: 6px;
    }
    
    .input-area input {
        font-size: 13px;
        padding: 8px 12px;
    }
    
    .icon-btn {
        font-size: 16px;
        width: 32px;
        height: 32px;
    }
    
    .section-label {
        font-size: 9px;
    }
    
    .user-item, .channel-item {
        padding: 10px 14px;
        font-size: 13px;
    }
    
    .header {
        padding: 12px;
        height: 56px;
    }
    
    #messages {
        padding: 12px;
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

</style>
</head>
<body>

<div id="login">
    <div class="login-box">
        <h2>ğŸ’¬ LAN Messenger</h2>
        <p>Connect with your team instantly</p>
        <input id="username" placeholder="Enter your name..." autocomplete="off">
        <button onclick="join()">START CHATTING</button>
        <p id="status">Connecting to server...</p>
    </div>
</div>

<div id="app">
    <div class="sidebar" id="sidebar">
        <div class="header">
            <button class="icon-btn" onclick="closeSidebar()" id="close-btn">
                <i class="fa-solid fa-times"></i>
            </button>
            <div id="current-user" style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:var(--glass);backdrop-filter:blur(10px);cursor:pointer;flex:1;" onclick="document.getElementById('avatar-input').click()">
                <img id="current-avatar" src="" class="avatar" style="width:40px;height:40px;">
                <div style="flex:1;">
                    <div id="current-name" style="font-weight:600;font-size:14px;"></div>
                    <div style="font-size:10px;color:var(--text-muted);">Online</div>
                </div>
                <button class="icon-btn" onclick="logout(event)" title="Logout" style="margin-left:auto;margin-right:5px;">
                    <i class="fa-solid fa-sign-out-alt"></i>
                </button>
                <i class="fa-solid fa-camera" style="font-size:12px;color:var(--text-muted);"></i>
            </div>
        </div>
        <div class="section-label">
            CHANNELS 
            <i class="fa-solid fa-plus icon-btn" onclick="event.stopPropagation(); createChannel();"></i>
        </div>
        <div id="channels"></div>
        <div class="section-label" style="margin-top: 15px;">ONLINE USERS</div>
        <div id="users"></div>
    </div>

    <div class="chat-area">
        <div class="header">
            <div style="display:flex;align-items:center;gap:10px;min-width:0;flex:1;">
                <button class="icon-btn" id="menu-btn" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div id="chat-title" style="font-weight:700;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">General</div>
            </div>
        </div>

        <div id="messages"></div>

        <div class="input-area">
            <button class="icon-btn" onclick="document.getElementById('file-input').click()" title="Upload file">
                <i class="fa-solid fa-paperclip"></i>
            </button>
            <input id="msg-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
            <button class="icon-btn" onclick="toggleStickerPicker()" title="Send sticker/GIF">
                <i class="fa-solid fa-smile"></i>
            </button>
            <button class="icon-btn" id="mic-btn" onmousedown="startVoiceRecord()" onmouseup="stopVoiceRecord()" onmouseleave="stopVoiceRecord()" ontouchstart="startVoiceRecord()" ontouchend="stopVoiceRecord()" ontouchcancel="stopVoiceRecord()" title="Hold to record voice">
                <i class="fa-solid fa-microphone"></i>
            </button>
            <button class="icon-btn" onclick="sendMsg()" title="Send message">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
        <div id="sticker-picker" style="display:none;position:absolute;bottom:60px;right:10px;background:var(--glass);backdrop-filter:blur(10px);border-radius:12px;padding:10px;max-width:300px;z-index:1000;">
            <div style="display:flex;flex-wrap:wrap;gap:5px;max-height:200px;overflow-y:auto;">
                <span onclick="sendSticker('ğŸ˜€')" style="cursor:pointer;font-size:24px;">ğŸ˜€</span>
                <span onclick="sendSticker('ğŸ˜‚')" style="cursor:pointer;font-size:24px;">ğŸ˜‚</span>
                <span onclick="sendSticker('â¤ï¸')" style="cursor:pointer;font-size:24px;">â¤ï¸</span>
                <span onclick="sendSticker('ğŸ‘')" style="cursor:pointer;font-size:24px;">ğŸ‘</span>
                <span onclick="sendSticker('ğŸ”¥')" style="cursor:pointer;font-size:24px;">ğŸ”¥</span>
                <span onclick="sendSticker('ğŸ‰')" style="cursor:pointer;font-size:24px;">ğŸ‰</span>
                <span onclick="sendSticker('ğŸ˜')" style="cursor:pointer;font-size:24px;">ğŸ˜</span>
                <span onclick="sendSticker('ğŸ¤”')" style="cursor:pointer;font-size:24px;">ğŸ¤”</span>
                <span onclick="sendSticker('ğŸ˜¢')" style="cursor:pointer;font-size:24px;">ğŸ˜¢</span>
                <span onclick="sendSticker('ğŸ‘')" style="cursor:pointer;font-size:24px;">ğŸ‘</span>
                <span onclick="sendSticker('ğŸ’¯')" style="cursor:pointer;font-size:24px;">ğŸ’¯</span>
                <span onclick="sendSticker('ğŸš€')" style="cursor:pointer;font-size:24px;">ğŸš€</span>
                <span onclick="sendSticker('ğŸ˜Š')" style="cursor:pointer;font-size:24px;">ğŸ˜Š</span>
                <span onclick="sendSticker('ğŸ˜')" style="cursor:pointer;font-size:24px;">ğŸ˜</span>
                <span onclick="sendSticker('ğŸ¥°')" style="cursor:pointer;font-size:24px;">ğŸ¥°</span>
                <span onclick="sendSticker('ğŸ˜˜')" style="cursor:pointer;font-size:24px;">ğŸ˜˜</span>
                <span onclick="sendSticker('ğŸ˜‰')" style="cursor:pointer;font-size:24px;">ğŸ˜‰</span>
                <span onclick="sendSticker('ğŸ˜œ')" style="cursor:pointer;font-size:24px;">ğŸ˜œ</span>
                <span onclick="sendSticker('ğŸ¤ª')" style="cursor:pointer;font-size:24px;">ğŸ¤ª</span>
                <span onclick="sendSticker('ğŸ˜')" style="cursor:pointer;font-size:24px;">ğŸ˜</span>
                <span onclick="sendSticker('ğŸ¤‘')" style="cursor:pointer;font-size:24px;">ğŸ¤‘</span>
                <span onclick="sendSticker('ğŸ¤—')" style="cursor:pointer;font-size:24px;">ğŸ¤—</span>
                <span onclick="sendSticker('ğŸ¤­')" style="cursor:pointer;font-size:24px;">ğŸ¤­</span>
                <span onclick="sendSticker('ğŸ¤«')" style="cursor:pointer;font-size:24px;">ğŸ¤«</span>
                <span onclick="sendSticker('ğŸ¤¨')" style="cursor:pointer;font-size:24px;">ğŸ¤¨</span>
                <span onclick="sendSticker('ğŸ˜')" style="cursor:pointer;font-size:24px;">ğŸ˜</span>
                <span onclick="sendSticker('ğŸ˜‘')" style="cursor:pointer;font-size:24px;">ğŸ˜‘</span>
                <span onclick="sendSticker('ğŸ˜¶')" style="cursor:pointer;font-size:24px;">ğŸ˜¶</span>
                <span onclick="sendSticker('ğŸ˜')" style="cursor:pointer;font-size:24px;">ğŸ˜</span>
                <span onclick="sendSticker('ğŸ˜’')" style="cursor:pointer;font-size:24px;">ğŸ˜’</span>
                <span onclick="sendSticker('ğŸ™„')" style="cursor:pointer;font-size:24px;">ğŸ™„</span>
                <span onclick="sendSticker('ğŸ˜¬')" style="cursor:pointer;font-size:24px;">ğŸ˜¬</span>
                <span onclick="sendSticker('ğŸ¤¥')" style="cursor:pointer;font-size:24px;">ğŸ¤¥</span>
                <span onclick="sendSticker('ğŸ˜”')" style="cursor:pointer;font-size:24px;">ğŸ˜”</span>
                <span onclick="sendSticker('ğŸ˜ª')" style="cursor:pointer;font-size:24px;">ğŸ˜ª</span>
                <span onclick="sendSticker('ğŸ¤¤')" style="cursor:pointer;font-size:24px;">ğŸ¤¤</span>
                <span onclick="sendSticker('ğŸ˜´')" style="cursor:pointer;font-size:24px;">ğŸ˜´</span>
                <span onclick="sendSticker('ğŸ˜·')" style="cursor:pointer;font-size:24px;">ğŸ˜·</span>
                <span onclick="sendSticker('ğŸ¤’')" style="cursor:pointer;font-size:24px;">ğŸ¤’</span>
                <span onclick="sendSticker('ğŸ¤•')" style="cursor:pointer;font-size:24px;">ğŸ¤•</span>
                <span onclick="sendSticker('ğŸ¤¢')" style="cursor:pointer;font-size:24px;">ğŸ¤¢</span>
                <span onclick="sendSticker('ğŸ¤®')" style="cursor:pointer;font-size:24px;">ğŸ¤®</span>
                <span onclick="sendSticker('ğŸ¤§')" style="cursor:pointer;font-size:24px;">ğŸ¤§</span>
                <span onclick="sendSticker('ğŸ¥µ')" style="cursor:pointer;font-size:24px;">ğŸ¥µ</span>
                <span onclick="sendSticker('ğŸ¥¶')" style="cursor:pointer;font-size:24px;">ğŸ¥¶</span>
                <span onclick="sendSticker('ğŸ¥´')" style="cursor:pointer;font-size:24px;">ğŸ¥´</span>
                <span onclick="sendSticker('ğŸ˜µ')" style="cursor:pointer;font-size:24px;">ğŸ˜µ</span>
                <span onclick="sendSticker('ğŸ¤¯')" style="cursor:pointer;font-size:24px;">ğŸ¤¯</span>
                <span onclick="sendSticker('ğŸ¤ ')" style="cursor:pointer;font-size:24px;">ğŸ¤ </span>
                <span onclick="sendSticker('ğŸ¥³')" style="cursor:pointer;font-size:24px;">ğŸ¥³</span>
                <span onclick="sendSticker('ğŸ¥¸')" style="cursor:pointer;font-size:24px;">ğŸ¥¸</span>
                <span onclick="sendSticker('ğŸ˜‡')" style="cursor:pointer;font-size:24px;">ğŸ˜‡</span>
                <span onclick="sendSticker('ğŸ‘¹')" style="cursor:pointer;font-size:24px;">ğŸ‘¹</span>
                <span onclick="sendSticker('ğŸ‘º')" style="cursor:pointer;font-size:24px;">ğŸ‘º</span>
                <span onclick="sendSticker('ğŸ’€')" style="cursor:pointer;font-size:24px;">ğŸ’€</span>
                <span onclick="sendSticker('ğŸ‘»')" style="cursor:pointer;font-size:24px;">ğŸ‘»</span>
                <span onclick="sendSticker('ğŸ‘½')" style="cursor:pointer;font-size:24px;">ğŸ‘½</span>
                <span onclick="sendSticker('ğŸ¤–')" style="cursor:pointer;font-size:24px;">ğŸ¤–</span>
                <span onclick="sendSticker('ğŸƒ')" style="cursor:pointer;font-size:24px;">ğŸƒ</span>
                <span onclick="sendSticker('ğŸ˜º')" style="cursor:pointer;font-size:24px;">ğŸ˜º</span>
                <span onclick="sendSticker('ğŸ˜¸')" style="cursor:pointer;font-size:24px;">ğŸ˜¸</span>
                <span onclick="sendSticker('ğŸ˜¹')" style="cursor:pointer;font-size:24px;">ğŸ˜¹</span>
                <span onclick="sendSticker('ğŸ˜»')" style="cursor:pointer;font-size:24px;">ğŸ˜»</span>
                <span onclick="sendSticker('ğŸ˜¼')" style="cursor:pointer;font-size:24px;">ğŸ˜¼</span>
                <span onclick="sendSticker('ğŸ˜½')" style="cursor:pointer;font-size:24px;">ğŸ˜½</span>
                <span onclick="sendSticker('ğŸ™€')" style="cursor:pointer;font-size:24px;">ğŸ™€</span>
                <span onclick="sendSticker('ğŸ˜¿')" style="cursor:pointer;font-size:24px;">ğŸ˜¿</span>
                <span onclick="sendSticker('ğŸ˜¾')" style="cursor:pointer;font-size:24px;">ğŸ˜¾</span>
                <span onclick="sendSticker('ğŸ‘‹')" style="cursor:pointer;font-size:24px;">ğŸ‘‹</span>
                <span onclick="sendSticker('ğŸ¤š')" style="cursor:pointer;font-size:24px;">ğŸ¤š</span>
                <span onclick="sendSticker('ğŸ–ï¸')" style="cursor:pointer;font-size:24px;">ğŸ–ï¸</span>
                <span onclick="sendSticker('âœ‹')" style="cursor:pointer;font-size:24px;">âœ‹</span>
                <span onclick="sendSticker('ğŸ––')" style="cursor:pointer;font-size:24px;">ğŸ––</span>
                <span onclick="sendSticker('ğŸ‘Œ')" style="cursor:pointer;font-size:24px;">ğŸ‘Œ</span>
                <span onclick="sendSticker('ğŸ¤')" style="cursor:pointer;font-size:24px;">ğŸ¤</span>
                <span onclick="sendSticker('âœŒï¸')" style="cursor:pointer;font-size:24px;">âœŒï¸</span>
                <span onclick="sendSticker('ğŸ¤')" style="cursor:pointer;font-size:24px;">ğŸ¤</span>
                <span onclick="sendSticker('ğŸ¤Ÿ')" style="cursor:pointer;font-size:24px;">ğŸ¤Ÿ</span>
                <span onclick="sendSticker('ğŸ¤˜')" style="cursor:pointer;font-size:24px;">ğŸ¤˜</span>
                <span onclick="sendSticker('ğŸ¤™')" style="cursor:pointer;font-size:24px;">ğŸ¤™</span>
                <span onclick="sendSticker('ğŸ‘ˆ')" style="cursor:pointer;font-size:24px;">ğŸ‘ˆ</span>
                <span onclick="sendSticker('ğŸ‘‰')" style="cursor:pointer;font-size:24px;">ğŸ‘‰</span>
                <span onclick="sendSticker('ğŸ‘†')" style="cursor:pointer;font-size:24px;">ğŸ‘†</span>
                <span onclick="sendSticker('ğŸ–•')" style="cursor:pointer;font-size:24px;">ğŸ–•</span>
                <span onclick="sendSticker('ğŸ‘‡')" style="cursor:pointer;font-size:24px;">ğŸ‘‡</span>
                <span onclick="sendSticker('â˜ï¸')" style="cursor:pointer;font-size:24px;">â˜ï¸</span>
                <span onclick="sendSticker('ğŸ‘')" style="cursor:pointer;font-size:24px;">ğŸ‘</span>
                <span onclick="sendSticker('ğŸ‘')" style="cursor:pointer;font-size:24px;">ğŸ‘</span>
                <span onclick="sendSticker('ğŸ‘Š')" style="cursor:pointer;font-size:24px;">ğŸ‘Š</span>
                <span onclick="sendSticker('âœŠ')" style="cursor:pointer;font-size:24px;">âœŠ</span>
                <span onclick="sendSticker('ğŸ¤›')" style="cursor:pointer;font-size:24px;">ğŸ¤›</span>
                <span onclick="sendSticker('ğŸ¤œ')" style="cursor:pointer;font-size:24px;">ğŸ¤œ</span>
                <span onclick="sendSticker('ğŸ‘')" style="cursor:pointer;font-size:24px;">ğŸ‘</span>
                <span onclick="sendSticker('ğŸ™Œ')" style="cursor:pointer;font-size:24px;">ğŸ™Œ</span>
                <span onclick="sendSticker('ğŸ‘')" style="cursor:pointer;font-size:24px;">ğŸ‘</span>
                <span onclick="sendSticker('ğŸ¤²')" style="cursor:pointer;font-size:24px;">ğŸ¤²</span>
                <span onclick="sendSticker('ğŸ¤')" style="cursor:pointer;font-size:24px;">ğŸ¤</span>
                <span onclick="sendSticker('ğŸ™')" style="cursor:pointer;font-size:24px;">ğŸ™</span>
                <span onclick="sendSticker('âœï¸')" style="cursor:pointer;font-size:24px;">âœï¸</span>
                <span onclick="sendSticker('ğŸ’…')" style="cursor:pointer;font-size:24px;">ğŸ’…</span>
                <span onclick="sendSticker('ğŸ¤³')" style="cursor:pointer;font-size:24px;">ğŸ¤³</span>
                <span onclick="sendSticker('ğŸ’ª')" style="cursor:pointer;font-size:24px;">ğŸ’ª</span>
                <span onclick="sendSticker('ğŸ¦¾')" style="cursor:pointer;font-size:24px;">ğŸ¦¾</span>
                <span onclick="sendSticker('ğŸ¦¿')" style="cursor:pointer;font-size:24px;">ğŸ¦¿</span>
                <span onclick="sendSticker('ğŸ¦µ')" style="cursor:pointer;font-size:24px;">ğŸ¦µ</span>
                <span onclick="sendSticker('ğŸ¦¶')" style="cursor:pointer;font-size:24px;">ğŸ¦¶</span>
                <span onclick="sendSticker('ğŸ‘‚')" style="cursor:pointer;font-size:24px;">ğŸ‘‚</span>
                <span onclick="sendSticker('ğŸ¦»')" style="cursor:pointer;font-size:24px;">ğŸ¦»</span>
                <span onclick="sendSticker('ğŸ‘ƒ')" style="cursor:pointer;font-size:24px;">ğŸ‘ƒ</span>
                <span onclick="sendSticker('ğŸ§ ')" style="cursor:pointer;font-size:24px;">ğŸ§ </span>
                <span onclick="sendSticker('ğŸ«€')" style="cursor:pointer;font-size:24px;">ğŸ«€</span>
                <span onclick="sendSticker('ğŸ«')" style="cursor:pointer;font-size:24px;">ğŸ«</span>
                <span onclick="sendSticker('ğŸ¦·')" style="cursor:pointer;font-size:24px;">ğŸ¦·</span>
                <span onclick="sendSticker('ğŸ¦´')" style="cursor:pointer;font-size:24px;">ğŸ¦´</span>
                <span onclick="sendSticker('ğŸ‘€')" style="cursor:pointer;font-size:24px;">ğŸ‘€</span>
                <span onclick="sendSticker('ğŸ‘ï¸')" style="cursor:pointer;font-size:24px;">ğŸ‘ï¸</span>
                <span onclick="sendSticker('ğŸ‘…')" style="cursor:pointer;font-size:24px;">ğŸ‘…</span>
                <span onclick="sendSticker('ğŸ‘„')" style="cursor:pointer;font-size:24px;">ğŸ‘„</span>
                <span onclick="sendSticker('ğŸ’‹')" style="cursor:pointer;font-size:24px;">ğŸ’‹</span>
                <span onclick="sendSticker('ğŸ©¸')" style="cursor:pointer;font-size:24px;">ğŸ©¸</span>
            </div>
            <div style="margin-top:10px;">
                <input id="gif-url" placeholder="Paste GIF URL..." style="width:100%;padding:5px;border-radius:5px;border:none;background:var(--input-bg);color:var(--text);">
                <button onclick="sendGif()" style="margin-top:5px;width:100%;padding:5px;background:var(--primary);color:white;border:none;border-radius:5px;">Send GIF</button>
            </div>
        </div>
        <input type="file" id="file-input" hidden onchange="uploadFile()">
        <input type="file" id="avatar-input" hidden accept="image/*" onchange="uploadAvatar()">
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io({ reconnection: true, reconnectionDelay: 1000, reconnectionDelayMax: 5000 });
let myUsername = "";
let currentRoom = "General";
let isPrivate = false;
let previousRoom = "General";
let usersList = {};
let usersByName = {};
let mediaRecorder = null;
let recordingChunks = [];
let recordingStream = null;
let isRecording = false;
let recordingStartTime = 0;

(function checkSession() {
    const storedUsername = localStorage.getItem('lanMessengerUsername');
    if (storedUsername) {
        myUsername = storedUsername;
        document.getElementById("username").value = storedUsername;
        join(true);
    }
})();

function scrollMessages() {
    const box = document.getElementById("messages");
    setTimeout(() => { box.scrollTop = box.scrollHeight; }, 0);
}

socket.on("connect", () => {
    document.getElementById("status").innerText = "Connected âœ“";
    document.getElementById("status").style.color = "rgba(255,255,255,0.9)";
    if (myUsername) {
        socket.emit("join", myUsername);
    }
});

socket.on("connect_error", () => {
    document.getElementById("status").innerText = "Server not reachable âœ—";
    document.getElementById("status").style.color = "#f56565";
});

socket.on("joinFail", (msg) => {
    alert(msg);
    localStorage.removeItem('lanMessengerUsername');
    myUsername = "";
    document.getElementById("username").value = "";
    document.getElementById("login").style.display = "flex";
    document.getElementById("app").style.display = "none";
});

function join(isReconnect = false) {
    const input = document.getElementById("username");
    const name = input.value.trim();
    if (!name) return alert("Please enter your name");
    
    localStorage.setItem('lanMessengerUsername', name);
    myUsername = name;
    socket.emit("join", myUsername);
}

socket.on("joinSuccess", () => {
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "flex";
    switchChatUIOnly("General", false);
    
    // Set current user
    document.getElementById("current-name").textContent = myUsername;
    const avatar = localStorage.getItem('lanMessengerAvatar') || `https://ui-avatars.com/api/?name=${encodeURIComponent(myUsername)}&background=667eea&color=fff&bold=true`;
    document.getElementById("current-avatar").src = avatar;
});

function updateActiveUserAndChannel(roomTitle, isPrivateChat) {
    document.querySelectorAll(".user-item, .channel-item").forEach(el => el.classList.remove("active"));
    document.getElementById("chat-title").innerText = roomTitle;

    if (isPrivateChat) {
        const userDiv = Array.from(document.querySelectorAll("#users .user-item span"))
            .find(span => span.textContent === roomTitle)?.closest(".user-item");
        if (userDiv) userDiv.classList.add("active");
    } else {
        const channelDiv = Array.from(document.querySelectorAll("#channels .channel-item"))
            .find(div => div.textContent.trim().includes(roomTitle));
        if (channelDiv) channelDiv.classList.add("active");
    }
}

socket.on("updateUserList", list => {
    usersList = list;
    usersByName = {};
    const div = document.getElementById("users");
    div.innerHTML = "";
    
    Object.entries(list).forEach(([id, u]) => {
        usersByName[u.username] = id;
        if (u.username === myUsername) return;
        
        const item = document.createElement("div");
        item.className = "user-item";
        item.innerHTML = `<img src="${u.avatar}" class="avatar"><span>${u.username}</span>`;
        item.onclick = () => switchChat(u.username, true);
        div.appendChild(item);
    });
    updateActiveUserAndChannel(currentRoom, isPrivate);
});

socket.on("channelList", list => {
    const div = document.getElementById("channels");
    div.innerHTML = "";
    
    list.forEach(c => {
        const item = document.createElement("div");
        item.className = "channel-item";
        item.innerHTML = `<i class="fa-solid fa-hashtag"></i> ${c.name} <span style="font-size:10px;color:var(--text-muted);float:right;">${c.members}</span>`;
        item.onclick = () => switchChat(c.name, false);
        div.appendChild(item);
    });
    updateActiveUserAndChannel(currentRoom, isPrivate);
});

function handleEnter(e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
    }
}

function sendMsg() {
    const input = document.getElementById("msg-input");
    const msg = input.value.trim();
    if (!msg) return;
    
    socket.emit("sendMessage", {
        room: currentRoom,
        isPrivate,
        type: "text",
        content: msg
    });
    input.value = "";
}

socket.on("receiveMessage", msg => {
    if (!msg || !msg.sender) return;
    
    let shouldShow = false;
    if (msg.isPrivate) {
        shouldShow = (msg.sender.username === currentRoom && isPrivate) || (msg.sender.username === myUsername && currentRoom === msg.room && isPrivate);
    } else {
        shouldShow = (msg.room === currentRoom && !isPrivate);
    }
    
    if (!shouldShow) return;
    renderMessage(msg);
    scrollMessages();
});

socket.on("loadMessages", msgs => {
    msgs.forEach(msg => renderMessage(msg));
    scrollMessages();
});

let messageQueue = [];
let renderTimeout = null;

function renderMessage(msg) {
    const box = document.getElementById("messages");
    // Limit to 50 messages for speed
    if (box.children.length >= 50) {
        box.removeChild(box.firstChild);
    }
    const div = document.createElement("div");
    const isMe = msg.sender.username === myUsername;
    div.className = `msg ${msg.type === 'system' ? 'system' : (isMe ? 'self' : 'other')}`;
    
    let content = msg.content;
    
    if (msg.type === "image") {
        content = `<div class="media-container"><img src="${msg.content}" alt="Image" onclick="window.open('${msg.content}', '_blank')"></div>`;
    } else if (msg.type === "video") {
        content = `<div class="media-container"><video src="${msg.content}" controls></video></div>`;
    } else if (msg.type === "audio") {
        content = `<audio src="${msg.content}" controls></audio>`;
    } else if (msg.type === "file") {
        const fname = msg.content.split('/').pop();
        content = `<a href="${msg.content}" target="_blank" style="color:white;text-decoration:underline;">ğŸ“„ ${fname}</a>`;
    }

    if (msg.type !== "system") {
        let ticks = '';
        if (isMe) {
            if (msg.readBy && msg.readBy.length > 1) {
                ticks = '<span style="color:#48bb78;">âœ“âœ“</span>';
            } else {
                ticks = '<span style="color:var(--text-muted);">âœ“</span>';
            }
        }
        div.innerHTML = `
            <span class="sender-name">${isMe ? 'You' : msg.sender.username}</span>
            ${content}
            <div style="font-size:10px;color:var(--text-muted);text-align:right;margin-top:3px;display:flex;justify-content:space-between;align-items:center;">
                <span>${msg.timestamp}</span>
                ${ticks}
            </div>
        `;
    } else {
        div.innerHTML = content;
    }
    
    box.appendChild(div);
    // Debounced scroll
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(() => scrollMessages(), 100);
}

// Debounce input for speed
let inputTimeout = null;
document.getElementById("msg-input").addEventListener("input", () => {
    clearTimeout(inputTimeout);
    inputTimeout = setTimeout(() => {
        // Optional: Add any processing here if needed
    }, 100);
});

function switchChatUIOnly(title, privateChat) {
    currentRoom = title;
    isPrivate = privateChat;
    updateActiveUserAndChannel(title, privateChat);
    closeSidebar();
}

function closeSidebar() {
    document.getElementById("sidebar").classList.remove("show");
}

function switchChat(title, privateChat = false) {
    if (currentRoom === title && isPrivate === privateChat) return;
    
    if (privateChat && !usersByName[title]) {
        alert("User is offline");
        return;
    }
    
    previousRoom = currentRoom;
    document.getElementById("messages").innerHTML = "";
    currentRoom = title;
    isPrivate = privateChat;
    updateActiveUserAndChannel(title, privateChat);

    if (privateChat) {
        socket.emit("joinPrivate", title);
    } else {
        let password = null;
        if (title !== 'General') {
            password = prompt(`Enter password for ${title}:`);
            if (password === null) {
                switchChatUIOnly(previousRoom, previousRoom !== 'General' && !!usersByName[previousRoom]);
                return;
            }
        }
        socket.emit("joinChannel", { name: title, password: password });
    }
    
    closeSidebar();
}

function createChannel() {
    const name = prompt("Enter Channel Name:");
    if (!name || !name.trim()) return;
    const password = prompt("Enter Password (optional):");
    socket.emit("createChannel", { name: name.trim(), password: password?.trim() || null });
}

function uploadAvatar() {
    const fileInput = document.getElementById("avatar-input");
    const file = fileInput.files[0];
    if (!file) return;
    
    const form = new FormData();
    form.append("file", file);
    
    fetch("/upload", { method: "POST", body: form })
        .then(r => r.json())
        .then(data => {
            const avatarUrl = data.url;
            localStorage.setItem('lanMessengerAvatar', avatarUrl);
            document.getElementById("current-avatar").src = avatarUrl;
            // Update user list
            socket.emit("updateAvatar", avatarUrl);
        })
        .catch(err => {
            console.error("Avatar upload error:", err);
            alert("Avatar upload failed.");
        });
    
    fileInput.value = "";
}

function uploadFile() {
    const fileInput = document.getElementById("file-input");
    const file = fileInput.files[0];
    if (!file) return;
    
    const form = new FormData();
    form.append("file", file);
    
    const tempMsg = document.createElement("div");
    tempMsg.className = "msg system";
    tempMsg.innerText = "Uploading file...";
    document.getElementById("messages").appendChild(tempMsg);
    scrollMessages();

    fetch("/upload", { method: "POST", body: form })
        .then(r => r.json())
        .then(data => {
            tempMsg.remove();
            let type = "file";
            if (data.type.startsWith("image/")) type = "image";
            else if (data.type.startsWith("video/")) type = "video";
            else if (data.type.startsWith("audio/")) type = "audio";
            
            socket.emit("sendMessage", { room: currentRoom, isPrivate, type, content: data.url });
        })
        .catch(err => {
            console.error("Upload error:", err);
            tempMsg.remove();
            alert("File upload failed.");
        });
    
    fileInput.value = "";
}

async function startVoiceRecord() {
    if (isRecording) return;
    
    const isSecure = window.location.protocol === 'https:' || 
                     window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1' ||
                     /^192\.168\./.test(window.location.hostname) ||
                     /^10\./.test(window.location.hostname) ||
                     /^172\.(1[6-9]|2[0-9]|3[0-1])\./.test(window.location.hostname);
    
    if (!isSecure) {
        alert("âš ï¸ Voice messages require HTTPS!");
        return;
    }
    
    try {
        isRecording = true;
        recordingStartTime = Date.now();
        recordingStream = await navigator.mediaDevices.getUserMedia({ 
            audio: { 
                echoCancellation: true, 
                noiseSuppression: true, 
                autoGainControl: true,
                sampleRate: 48000,
                channelCount: 1
            } 
        });
        recordingChunks = [];
        
        const micBtn = document.getElementById("mic-btn");
        micBtn.classList.add("recording");
        document.getElementById("msg-input").placeholder = "ğŸ™ï¸ Recording...";
        
        let mimeType = 'audio/webm;codecs=opus';
        if (!MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            mimeType = 'audio/webm';
        }
        
        const options = {
            mimeType,
            audioBitsPerSecond: 192000 // Confirmed 192kbps
        };
        
        mediaRecorder = new MediaRecorder(recordingStream, options);
        
        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) recordingChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
            const duration = Date.now() - recordingStartTime;
            const micBtn = document.getElementById("mic-btn");
            micBtn.classList.remove("recording");
            document.getElementById("msg-input").placeholder = "Type a message...";
            
            if (duration < 500 || recordingChunks.length === 0) {
                cleanupRecording();
                return;
            }
            
            const blob = new Blob(recordingChunks, { type: mimeType });
            if (blob.size < 100) {
                cleanupRecording();
                return;
            }
            
            const formData = new FormData();
            formData.append("file", blob, `voice_${Date.now()}.webm`);
            
            const tempMsg = document.createElement("div");
            tempMsg.className = "msg system";
            tempMsg.innerText = "Uploading voice...";
            document.getElementById("messages").appendChild(tempMsg);
            scrollMessages();

            try {
                const res = await fetch("/upload", { method: "POST", body: formData });
                const data = await res.json();
                tempMsg.remove();
                socket.emit("sendMessage", { room: currentRoom, isPrivate, type: "audio", content: data.url });
            } catch (err) {
                tempMsg.remove();
                console.error("Audio upload error:", err);
            }
            
            cleanupRecording();
        };
        
        mediaRecorder.start();
        
    } catch (err) {
        alert("Microphone access denied");
        isRecording = false;
        const micBtn = document.getElementById("mic-btn");
        micBtn.classList.remove("recording");
    }
}

function stopVoiceRecord() {
    const micBtn = document.getElementById("mic-btn");
    
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
    }
    
    micBtn.classList.remove("recording");
}

function cleanupRecording() {
    if (recordingStream) {
        recordingStream.getTracks().forEach(track => track.stop());
        recordingStream = null;
    }
    mediaRecorder = null;
    recordingChunks = [];
    isRecording = false;
}

function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const isShowing = sidebar.classList.contains("show");
    
    if (isShowing) {
        sidebar.classList.remove("show");
        document.removeEventListener('click', closeSidebarOnClickOutside, true);
    } else {
        sidebar.classList.add("show");
        document.getElementById("sticker-picker").style.display = "none";
        // Add listener to close when clicking outside
        setTimeout(() => {
            document.addEventListener('click', closeSidebarOnClickOutside, true);
        }, 10); // Small delay to prevent immediate trigger
    }
}

function toggleStickerPicker() {
    const picker = document.getElementById("sticker-picker");
    picker.style.display = picker.style.display === "none" ? "block" : "none";
}

function sendSticker(sticker) {
    socket.emit("sendMessage", {
        room: currentRoom,
        isPrivate,
        type: "text",
        content: sticker
    });
    document.getElementById("sticker-picker").style.display = "none";
}

function sendGif() {
    const gifUrl = document.getElementById("gif-url").value.trim();
    if (!gifUrl) return;
    socket.emit("sendMessage", {
        room: currentRoom,
        isPrivate,
        type: "image",
        content: gifUrl
    });
    document.getElementById("gif-url").value = "";
    document.getElementById("sticker-picker").style.display = "none";
}

function logout(event) {
    event.stopPropagation();
    localStorage.removeItem('lanMessengerUsername');
    localStorage.removeItem('lanMessengerAvatar');
    location.reload();
}

socket.on("disconnect", () => {
    document.getElementById("status").innerText = "Disconnected âœ—";
    document.getElementById("status").style.color = "#f56565";
});

function fixVH() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
}
fixVH();
window.addEventListener('resize', fixVH);
</script>
</body>
</html>