<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAN Messenger</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root { 
    --bg: #0a0e27;
    --sidebar: #151932;
    --chat-bg: #0f1229;
    --primary: #667eea;
    --accent: #48bb78;
    --text: #e2e8f0;
    --text-muted: #94a3b8;
    --msg-in: #1e293b;
    --msg-out: #667eea;
    --input-bg: #1e293b;
    --separator: #2d3748;
    --danger: #f56565;
}

* {
    box-sizing: border-box; 
    margin: 0;
    padding: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

html, body {
    width: 100%;
    height: 100%;
}

body {
    background: var(--bg);
    color: var(--text);
    overflow: hidden; 
    display: flex;
    flex-direction: column;
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }

#login {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.login-box {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 40px 30px;
    border-radius: 20px;
    text-align: center;
    width: 90%;
    max-width: 350px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.2);
}

.login-box h2 {
    margin-bottom: 10px;
    color: white;
    font-size: 28px;
    font-weight: 700;
}

.login-box p {
    color: rgba(255,255,255,0.8);
    margin-bottom: 25px;
    font-size: 13px;
}

.login-box input {
    width: 100%;
    padding: 12px 16px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: white;
    outline: none;
    font-size: 15px;
    transition: all 0.3s;
}

.login-box input::placeholder {
    color: rgba(255,255,255,0.6);
}

.login-box input:focus {
    border-color: white;
    background: rgba(255,255,255,0.15);
}

.login-box button {
    width: 100%;
    padding: 12px;
    background: white;
    color: #667eea;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    font-size: 15px;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.login-box button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

#status {
    margin-top: 15px;
    font-size: 12px;
    color: rgba(255,255,255,0.9);
}

#app {
    display: none;
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: row;
}

.sidebar {
    width: 280px;
    background: var(--sidebar);
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--separator);
    overflow-y: auto;
    flex-shrink: 0;
}

.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--chat-bg);
    min-width: 0;
}

.header {
    padding: 15px 18px;
    background: var(--sidebar);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--separator);
    height: 60px;
    flex-shrink: 0;
}

.section-label {
    padding: 12px 16px 8px;
    color: var(--text-muted);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.user-item, .channel-item {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s;
    margin: 0 8px;
    border-radius: 8px;
    user-select: none;
}

.user-item:hover, .channel-item:hover {
    background: rgba(102, 126, 234, 0.1);
}

.user-item.active, .channel-item.active {
    background: var(--primary);
    color: white;
}

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary);
    flex-shrink: 0;
}

#messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: var(--chat-bg);
}

.msg {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.4;
    overflow-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    word-break: break-word;
}

.msg.self {
    align-self: flex-end;
    background: var(--msg-out);
    color: white;
    border-bottom-right-radius: 4px;
}

.msg.other {
    align-self: flex-start;
    background: var(--msg-in);
    border-bottom-left-radius: 4px;
}

.msg.system {
    align-self: center;
    background: rgba(255,255,255,0.05);
    color: var(--text-muted);
    font-size: 12px;
    border-radius: 16px;
    padding: 6px 12px;
    margin: 10px 0;
    max-width: 90%;
}

.media-container {
    max-width: 240px;
    max-height: 240px;
    margin-top: 6px;
    border-radius: 10px;
    overflow: hidden;
    background: black;
    display: inline-block;
}

.media-container img, .media-container video {
    max-width: 100%;
    max-height: 100%;
    display: block;
    object-fit: cover;
    cursor: pointer;
}

.msg audio {
    max-width: 100%;
    border-radius: 6px;
    margin-top: 6px;
    display: block;
    height: 32px;
}

.sender-name {
    font-size: 11px;
    color: var(--accent);
    margin-bottom: 3px;
    display: block;
    font-weight: 600;
}

.input-area {
    background: var(--sidebar);
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    border-top: 1px solid var(--separator);
}

.input-area input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 20px;
    border: none;
    background: var(--input-bg);
    color: var(--text);
    outline: none;
    font-size: 14px;
}

.input-area input:focus {
    background: rgba(102, 126, 234, 0.15);
}

.icon-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 18px;
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    transition: all 0.2s;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
}

.icon-btn:hover {
    color: var(--primary);
    background: rgba(102, 126, 234, 0.1);
}

.icon-btn:active {
    transform: scale(0.9);
}

.recording {
    color: var(--danger);
    animation: pulse 1.5s infinite;
}

@media(max-width: 768px) {
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: 260px;
        z-index: 999;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 2px 0 20px rgba(0,0,0,0.5);
    }
    
    .sidebar.show {
        transform: translateX(0);
    }
    
    #menu-btn {
        display: flex !important;
    }
    
    .msg {
        max-width: 80%;
    }
    
    .media-container {
        max-width: 180px;
        max-height: 180px;
    }
    
    .header {
        padding: 12px 14px;
        height: 55px;
    }
    
    #messages {
        padding: 12px;
    }
    
    .input-area {
        padding: 10px;
        gap: 6px;
    }
    
    .icon-btn {
        font-size: 16px;
        width: 34px;
        height: 34px;
        padding: 5px;
    }
    
    .avatar {
        width: 32px;
        height: 32px;
    }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}
</style>
</head>
<body>

<div id="login">
    <div class="login-box">
        <h2>ðŸ’¬ LAN Messenger</h2>
        <p>Connect with your team instantly</p>
        <input id="username" placeholder="Enter your name..." autocomplete="off">
        <button onclick="join()">START CHATTING</button>
        <p id="status">Connecting to server...</p>
    </div>
</div>

<div id="app">
    <div class="sidebar" id="sidebar">
        <div class="header">
            <h3 style="font-size: 18px; font-weight: 700;">Chats</h3>
        </div>
        <div class="section-label">
            CHANNELS 
            <i class="fa-solid fa-plus" style="cursor:pointer;font-size:12px;" onclick="createChannel()"></i>
        </div>
        <div id="channels"></div>
        <div class="section-label" style="margin-top: 15px;">ONLINE USERS</div>
        <div id="users"></div>
    </div>

    <div class="chat-area">
        <div class="header">
            <div style="display:flex;align-items:center;gap:10px;min-width:0;flex:1;">
                <button class="icon-btn" id="menu-btn" onclick="toggleSidebar()" style="display:none;">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div id="chat-title" style="font-weight:700;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">General</div>
            </div>
        </div>

        <div id="messages"></div>

        <div class="input-area">
            <button class="icon-btn" onclick="document.getElementById('file-input').click()" title="Upload file">
                <i class="fa-solid fa-paperclip"></i>
            </button>
            <input id="msg-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
            <button class="icon-btn" id="mic-btn" onmousedown="startVoiceRecord()" onmouseup="stopVoiceRecord()" onmouseleave="stopVoiceRecord()" ontouchstart="startVoiceRecord()" ontouchend="stopVoiceRecord()" ontouchcancel="stopVoiceRecord()" title="Hold to record voice">
                <i class="fa-solid fa-microphone"></i>
            </button>
            <button class="icon-btn" onclick="sendMsg()" title="Send message">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
        <input type="file" id="file-input" hidden onchange="uploadFile()">
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io({ reconnection: true, reconnectionDelay: 1000, reconnectionDelayMax: 5000 });
let myUsername = "";
let currentRoom = "General";
let isPrivate = false;
let previousRoom = "General";
let usersList = {};
let usersByName = {};
let mediaRecorder = null;
let recordingChunks = [];
let recordingStream = null;
let isRecording = false;
let recordingStartTime = 0;

(function checkSession() {
    const storedUsername = localStorage.getItem('lanMessengerUsername');
    if (storedUsername) {
        myUsername = storedUsername;
        document.getElementById("username").value = storedUsername;
        join(true);
    }
})();

function scrollMessages() {
    const box = document.getElementById("messages");
    setTimeout(() => { box.scrollTop = box.scrollHeight; }, 0);
}

socket.on("connect", () => {
    document.getElementById("status").innerText = "Connected âœ“";
    document.getElementById("status").style.color = "rgba(255,255,255,0.9)";
    if (myUsername) {
        socket.emit("join", myUsername);
    }
});

socket.on("connect_error", () => {
    document.getElementById("status").innerText = "Server not reachable âœ—";
    document.getElementById("status").style.color = "#f56565";
});

socket.on("joinFail", (msg) => {
    alert(msg);
    localStorage.removeItem('lanMessengerUsername');
    myUsername = "";
    document.getElementById("username").value = "";
    document.getElementById("login").style.display = "flex";
    document.getElementById("app").style.display = "none";
});

function join(isReconnect = false) {
    const input = document.getElementById("username");
    const name = input.value.trim();
    if (!name) return alert("Please enter your name");
    
    localStorage.setItem('lanMessengerUsername', name);
    myUsername = name;
    socket.emit("join", myUsername);
}

socket.on("joinSuccess", () => {
    console.log("âœ… Join successful for user:", myUsername);
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "flex";
    
    // Small delay to ensure UI is rendered
    setTimeout(() => {
        switchChatUIOnly("General", false);
    }, 100);
});

function updateActiveUserAndChannel(roomTitle, isPrivateChat) {
    document.querySelectorAll(".user-item, .channel-item").forEach(el => el.classList.remove("active"));
    document.getElementById("chat-title").innerText = roomTitle;

    if (isPrivateChat) {
        const userDiv = Array.from(document.querySelectorAll("#users .user-item span"))
            .find(span => span.textContent === roomTitle)?.closest(".user-item");
        if (userDiv) userDiv.classList.add("active");
    } else {
        const channelDiv = Array.from(document.querySelectorAll("#channels .channel-item"))
            .find(div => div.textContent.trim().includes(roomTitle));
        if (channelDiv) channelDiv.classList.add("active");
    }
}

socket.on("updateUserList", list => {
    usersList = list;
    usersByName = {};
    const div = document.getElementById("users");
    div.innerHTML = "";
    
    Object.entries(list).forEach(([id, u]) => {
        usersByName[u.username] = id;
        if (u.username === myUsername) return;
        
        const item = document.createElement("div");
        item.className = "user-item";
        item.innerHTML = `<img src="${u.avatar}" class="avatar"><span>${u.username}</span>`;
        item.onclick = () => {
            switchChat(u.username, true);
        };
        div.appendChild(item);
    });
    
    updateActiveUserAndChannel(currentRoom, isPrivate);
});

socket.on("channelList", list => {
    const div = document.getElementById("channels");
    div.innerHTML = "";
    
    list.forEach(c => {
        const item = document.createElement("div");
        item.className = "channel-item";
        item.innerHTML = `<i class="fa-solid fa-hashtag"></i> ${c}`;
        item.onclick = () => {
            switchChat(c, false);
        };
        div.appendChild(item);
    });
    
    updateActiveUserAndChannel(currentRoom, isPrivate);
});

function handleEnter(e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
    }
}

function sendMsg() {
    const input = document.getElementById("msg-input");
    const msg = input.value.trim();
    if (!msg) return;
    
    socket.emit("sendMessage", {
        room: currentRoom,
        isPrivate,
        type: "text",
        content: msg
    });
    input.value = "";
}

socket.on("receiveMessage", msg => {
    if (!msg || !msg.sender) return;
    
    let shouldShow = false;
    if (msg.isPrivate) {
        shouldShow = (msg.sender.username === currentRoom && isPrivate) || (msg.sender.username === myUsername && currentRoom === msg.room && isPrivate);
    } else {
        shouldShow = (msg.room === currentRoom && !isPrivate);
    }
    
    if (!shouldShow) return;

    const box = document.getElementById("messages");
    const div = document.createElement("div");
    const isMe = msg.sender.username === myUsername;
    div.className = `msg ${msg.type === 'system' ? 'system' : (isMe ? 'self' : 'other')}`;
    
    let content = msg.content;
    
    if (msg.type === "image") {
        content = `<div class="media-container"><img src="${msg.content}" alt="Image" onclick="window.open('${msg.content}', '_blank')"></div>`;
    } else if (msg.type === "video") {
        content = `<div class="media-container"><video src="${msg.content}" controls></video></div>`;
    } else if (msg.type === "audio") {
        content = `<audio src="${msg.content}" controls></audio>`;
    } else if (msg.type === "file") {
        const fname = msg.content.split('/').pop();
        content = `<a href="${msg.content}" target="_blank" style="color:white;text-decoration:underline;">ðŸ“„ ${fname}</a>`;
    }

    if (msg.type !== "system") {
        div.innerHTML = `
            <span class="sender-name">${isMe ? 'You' : msg.sender.username}</span>
            ${content}
            <div style="font-size:10px;color:var(--text-muted);text-align:right;margin-top:3px;">${msg.timestamp}</div>
        `;
    } else {
        div.innerHTML = content;
    }
    
    box.appendChild(div);
    scrollMessages();
});

function switchChatUIOnly(title, privateChat) {
    currentRoom = title;
    isPrivate = privateChat;
    updateActiveUserAndChannel(title, privateChat);
    closeSidebar();
}

function closeSidebar() {
    document.getElementById("sidebar").classList.remove("show");
}

function switchChat(title, privateChat = false) {
    if (currentRoom === title && isPrivate === privateChat) return;
    
    previousRoom = currentRoom;
    document.getElementById("messages").innerHTML = "";
    currentRoom = title;
    isPrivate = privateChat;
    updateActiveUserAndChannel(title, privateChat);

    if (privateChat) {
        socket.emit("joinPrivate", title);
    } else {
        let password = null;
        if (title !== 'General') {
            password = prompt(`Enter password for ${title}:`);
            if (password === null) {
                switchChatUIOnly(previousRoom, previousRoom !== 'General' && !!usersByName[previousRoom]);
                return;
            }
        }
        socket.emit("joinChannel", { name: title, password: password });
    }
    
    closeSidebar();
    
    document.addEventListener('click', closeSidebarOnClickOutside, true);
}

function closeSidebarOnClickOutside(e) {
    const sidebar = document.getElementById("sidebar");
    const menuBtn = document.getElementById("menu-btn");
    
    if (window.innerWidth <= 768 && sidebar.classList.contains("show")) {
        if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
            sidebar.classList.remove("show");
        }
    }
}

function createChannel() {
    const name = prompt("Enter Channel Name:");
    if (!name || !name.trim()) return;
    const password = prompt("Enter Password (optional):");
    socket.emit("createChannel", { name: name.trim(), password: password?.trim() || null });
}

function uploadFile() {
    const fileInput = document.getElementById("file-input");
    const file = fileInput.files[0];
    if (!file) return;
    
    const form = new FormData();
    form.append("file", file);
    
    const tempMsg = document.createElement("div");
    tempMsg.className = "msg system";
    tempMsg.innerText = "Uploading file...";
    document.getElementById("messages").appendChild(tempMsg);
    scrollMessages();

    fetch("/upload", { method: "POST", body: form })
        .then(r => r.json())
        .then(data => {
            tempMsg.remove();
            let type = "file";
            if (data.type.startsWith("image/")) type = "image";
            else if (data.type.startsWith("video/")) type = "video";
            else if (data.type.startsWith("audio/")) type = "audio";
            
            socket.emit("sendMessage", { room: currentRoom, isPrivate, type, content: data.url });
        })
        .catch(err => {
            console.error("Upload error:", err);
            tempMsg.remove();
            alert("File upload failed.");
        });
    
    fileInput.value = "";
}

async function startVoiceRecord() {
    if (isRecording) return;
    
    const isSecure = window.location.protocol === 'https:' || 
                     window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1';
    
    if (!isSecure) {
        alert("âš ï¸ Voice messages require HTTPS!");
        return;
    }
    
    try {
        isRecording = true;
        recordingStartTime = Date.now();
        recordingStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordingChunks = [];
        
        const micBtn = document.getElementById("mic-btn");
        micBtn.classList.add("recording");
        document.getElementById("msg-input").placeholder = "ðŸŽ™ï¸ Recording...";
        
        let mimeType = 'audio/webm';
        if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            mimeType = 'audio/webm;codecs=opus';
        }
        
        mediaRecorder = new MediaRecorder(recordingStream, { mimeType });
        
        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) recordingChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
            const duration = Date.now() - recordingStartTime;
            const micBtn = document.getElementById("mic-btn");
            micBtn.classList.remove("recording");
            document.getElementById("msg-input").placeholder = "Type a message...";
            
            if (duration < 500 || recordingChunks.length === 0) {
                cleanupRecording();
                return;
            }
            
            const blob = new Blob(recordingChunks, { type: mimeType });
            if (blob.size < 100) {
                cleanupRecording();
                return;
            }
            
            const formData = new FormData();
            formData.append("file", blob, `voice_${Date.now()}.webm`);
            
            const tempMsg = document.createElement("div");
            tempMsg.className = "msg system";
            tempMsg.innerText = "Uploading voice...";
            document.getElementById("messages").appendChild(tempMsg);
            scrollMessages();

            try {
                const res = await fetch("/upload", { method: "POST", body: formData });
                const data = await res.json();
                tempMsg.remove();
                socket.emit("sendMessage", { room: currentRoom, isPrivate, type: "audio", content: data.url });
            } catch (err) {
                tempMsg.remove();
                console.error("Audio upload error:", err);
            }
            
            cleanupRecording();
        };
        
        mediaRecorder.start();
        
    } catch (err) {
        alert("Microphone access denied");
        isRecording = false;
        const micBtn = document.getElementById("mic-btn");
        micBtn.classList.remove("recording");
    }
}

function stopVoiceRecord() {
    const micBtn = document.getElementById("mic-btn");
    
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
    }
    
    micBtn.classList.remove("recording");
}

function cleanupRecording() {
    if (recordingStream) {
        recordingStream.getTracks().forEach(track => track.stop());
        recordingStream = null;
    }
    mediaRecorder = null;
    recordingChunks = [];
    isRecording = false;
}

function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("show");
}

socket.on("disconnect", () => {
    document.getElementById("status").innerText = "Disconnected âœ—";
    document.getElementById("status").style.color = "#f56565";
});
</script>
</body>
</html>